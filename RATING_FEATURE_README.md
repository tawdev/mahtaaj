# ميزة التقييم مرة واحدة لكل مستخدم

## نظرة عامة
تم إضافة ميزة تسمح لكل مستخدم مسجل بتقييم الموقع مرة واحدة فقط. بمجرد أن يقوم المستخدم بتقييم الموقع، لن يتمكن من التقييم مرة أخرى.

## التغييرات المنفذة

### 1. ملف API (`site-menage/src/api-supabase.js`)

#### دالة جديدة: `hasUserRatedSite()`
- تتحقق من وجود تقييم سابق للمستخدم الحالي
- ترجع `{ hasRated: boolean, rating: object | null }`
- تتحقق فقط من تقييمات الموقع (حيث `product_id IS NULL`)

#### تحديث دالة `submitRating()`
- تتحقق من وجود تقييم سابق قبل إدراج تقييم جديد
- تمنع إدراج تقييمات مكررة للمستخدمين المسجلين
- ترجع رسالة خطأ واضحة إذا حاول المستخدم التقييم مرة ثانية

#### تحديث دوال `getRatings()` و `getAllRatings()`
- تم تحديثهما لإرجاع تقييمات الموقع فقط (حيث `product_id IS NULL`)
- هذا يضمن فصل تقييمات الموقع عن تقييمات المنتجات

### 2. مكون React (`site-menage/src/components/UserRating.jsx`)

#### حالات جديدة:
- `hasRated`: يشير إلى ما إذا كان المستخدم قد قيّم بالفعل
- `userRating`: يحتوي على بيانات التقييم السابق للمستخدم
- `checkingRating`: حالة تحميل أثناء التحقق من التقييم السابق

#### ميزات جديدة:
- التحقق التلقائي من التقييم السابق عند تحميل المكون
- إخفاء نموذج التقييم إذا كان المستخدم قد قيّم بالفعل
- عرض التقييم السابق للمستخدم (النجوم والتعليق والتاريخ)
- رسالة واضحة تخبر المستخدم أنه لا يمكنه التقييم مرة أخرى

### 3. ملف CSS (`site-menage/src/components/UserRating.css`)

#### أنماط جديدة:
- `.rating-loading`: حالة التحميل أثناء التحقق
- `.rating-already-submitted`: حالة "تم التقييم بالفعل"
- `.user-rating-display`: عرض التقييم السابق للمستخدم
- `.already-rated-message`: رسالة إعلامية

### 4. قاعدة البيانات (`add-unique-site-rating-constraint.sql`)

#### فهرس فريد جزئي:
```sql
CREATE UNIQUE INDEX unique_site_rating_per_user 
ON ratings (user_id) 
WHERE product_id IS NULL AND user_id IS NOT NULL;
```

هذا الفهرس يضمن على مستوى قاعدة البيانات أن:
- كل مستخدم مسجل يمكنه تقييم الموقع مرة واحدة فقط
- التقييمات للمنتجات لا تتأثر بهذا القيد
- المستخدمون غير المسجلين (user_id IS NULL) لا يتأثرون بهذا القيد

## كيفية الاستخدام

### 1. تطبيق التغييرات على قاعدة البيانات

قم بتشغيل ملف SQL في Supabase SQL Editor:
```sql
-- انسخ محتوى ملف add-unique-site-rating-constraint.sql
-- والصقه في Supabase SQL Editor ثم قم بتنفيذه
```

### 2. اختبار الميزة

1. سجّل الدخول كمسخدم
2. انتقل إلى صفحة التقييم
3. قم بتقييم الموقع
4. حاول التقييم مرة أخرى - يجب أن ترى رسالة تفيد بأنك قيّمت بالفعل

## ملاحظات مهمة

### المستخدمون غير المسجلين
- المستخدمون غير المسجلين (بدون حساب) يمكنهم التقييم
- لا يتم التحقق من التقييمات المكررة للمستخدمين غير المسجلين على مستوى قاعدة البيانات
- يمكن إضافة فحص إضافي بناءً على IP إذا لزم الأمر

### التقييمات للمنتجات
- هذه الميزة تؤثر فقط على تقييمات الموقع (حيث `product_id IS NULL`)
- تقييمات المنتجات لها منطق منفصل في صفحة المتجر

### الأمان
- يتم التحقق من التقييمات المكررة على مستويين:
  1. مستوى التطبيق (في `submitRating()`)
  2. مستوى قاعدة البيانات (الفهرس الفريد)

## الملفات المعدلة

1. `site-menage/src/api-supabase.js` - إضافة دوال جديدة وتحديث الدوال الموجودة
2. `site-menage/src/components/UserRating.jsx` - تحديث المكون للتحقق من التقييمات السابقة
3. `site-menage/src/components/UserRating.css` - إضافة أنماط CSS جديدة
4. `add-unique-site-rating-constraint.sql` - ملف SQL لإضافة القيد الفريد

## الخطوات التالية (اختياري)

إذا كنت تريد أيضاً منع التقييمات المكررة للمستخدمين غير المسجلين:
1. يمكنك إضافة فحص بناءً على IP address
2. أو تشجيع المستخدمين على تسجيل الدخول قبل التقييم

